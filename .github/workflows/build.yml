name: Build and publish

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    tags:
      - "*/v*"

jobs:
  # Tests already passed before tag was created, so just build and deploy
  deploy:
    runs-on: ubuntu-latest
    name: "Build and publish to npm"
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Check out
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          filter: blob:none
      - uses: oven-sh/setup-bun@v2
      - name: Extract package name from tag
        id: extract
        run: |
          TAG=${{ github.ref_name }}
          PACKAGE_NAME=$(echo $TAG | sed 's|/.*||')
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "Publishing package: $PACKAGE_NAME"
      - name: Install dependencies
        run: bun i
      - name: Check plugin wiring
        run: bun run check:wiring
      - name: Build package
        run: |
          cd packages/${{ steps.extract.outputs.package_name }}
          bun run build
      - name: Generate changelog
        id: changelog
        run: |
          set -euo pipefail
          CURRENT_TAG="${{ github.ref_name }}"
          PKG="${{ steps.extract.outputs.package_name }}"

          # Find the previous tag for this package (same tag namespace), excluding the current tag.
          PREV_TAG="$(git tag --list "$PKG/v*" --sort=-v:refname | grep -Fxv "$CURRENT_TAG" | head -n 1 || true)"

          if [ -z "$PREV_TAG" ]; then
            # First release in the new tag namespace; just show recent commits touching this package.
            CHANGELOG="$(git log -n 20 --pretty=format:'- %s (%h)' "$CURRENT_TAG" -- "packages/$PKG" || true)"
            FIRST_PKG_COMMIT="$(git log --reverse --format=%H "$CURRENT_TAG" -- "packages/$PKG" | head -n 1 || true)"
            if [ -n "$FIRST_PKG_COMMIT" ]; then
              PREV_TAG="$(git rev-parse "${FIRST_PKG_COMMIT}^" 2>/dev/null || echo "$FIRST_PKG_COMMIT")"
            else
              PREV_TAG="$(git rev-parse "${CURRENT_TAG}^" 2>/dev/null || echo "$CURRENT_TAG")"
            fi
          else
            CHANGELOG="$(git log --pretty=format:'- %s (%h)' "$PREV_TAG..$CURRENT_TAG" -- "packages/$PKG" || true)"
          fi

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="(no changes detected)"
          fi

          {
            echo "from_tag=$PREV_TAG"
            echo "to_tag=$CURRENT_TAG"
            echo "result<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Publish to npm
        uses: js-devtools/npm-publish@v4
        if: ${{ !contains(github.ref, '-alpha.') }}
        with:
          token: ${{ secrets.NPM_TOKEN }}
          provenance: true
          package: packages/${{ steps.extract.outputs.package_name }}/package.json
      - name: Publish to npm (alpha)
        uses: js-devtools/npm-publish@v4
        if: ${{ contains(github.ref, '-alpha.') }}
        with:
          token: ${{ secrets.NPM_TOKEN }}
          tag: next
          provenance: true
          package: packages/${{ steps.extract.outputs.package_name }}/package.json
      - name: Create GitHub release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## ðŸ†• Changelog

            ${{ steps.changelog.outputs.result }}

            ---

            ðŸ”— **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.changelog.outputs.from_tag }}...${{ steps.changelog.outputs.to_tag }}
          make_latest: true
          token: '${{ secrets.PERSONAL_ACCESS_TOKEN }}'
          prerelease: ${{ contains(github.ref, '-alpha.') }}
